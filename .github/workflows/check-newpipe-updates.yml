# Check for NewPipe Extractor updates
# NewPipe Extractor is critical for YouTube stream extraction
# This workflow runs weekly and creates an issue if a new version is available

name: Check NewPipe Extractor Updates

on:
  schedule:
    # Run every Monday at 10:00 UTC
    - cron: '0 10 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current NewPipe version
        id: current
        run: |
          CURRENT_VERSION=$(grep 'newpipe = "' gradle/libs.versions.toml | sed 's/.*= "\(.*\)"/\1/')
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current NewPipe Extractor version: $CURRENT_VERSION"

      - name: Get latest NewPipe Extractor release
        id: latest
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/TeamNewPipe/NewPipeExtractor/releases/latest | jq -r '.tag_name')
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest NewPipe Extractor version: $LATEST_VERSION"

      - name: Compare versions
        id: compare
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"

          if [ "$CURRENT" != "$LATEST" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "New version available: $LATEST (current: $CURRENT)"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Already on latest version: $CURRENT"
          fi

      - name: Get release notes
        id: notes
        if: steps.compare.outputs.update_available == 'true'
        run: |
          NOTES=$(curl -s https://api.github.com/repos/TeamNewPipe/NewPipeExtractor/releases/latest | jq -r '.body' | head -50)
          # Escape for GitHub Actions
          NOTES="${NOTES//'%'/'%25'}"
          NOTES="${NOTES//$'\n'/'%0A'}"
          NOTES="${NOTES//$'\r'/'%0D'}"
          echo "notes=$NOTES" >> $GITHUB_OUTPUT

      - name: Create or update issue
        if: steps.compare.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Update NewPipe Extractor to ${{ steps.latest.outputs.version }}`;
            const currentVersion = '${{ steps.current.outputs.version }}';
            const latestVersion = '${{ steps.latest.outputs.version }}';

            const body = `## NewPipe Extractor Update Available

            A new version of NewPipe Extractor is available. This library is critical for YouTube stream extraction.

            | Current | Latest |
            |---------|--------|
            | ${currentVersion} | ${latestVersion} |

            ### Release Notes
            See: https://github.com/TeamNewPipe/NewPipeExtractor/releases/tag/${latestVersion}

            ### How to Update
            Edit \`gradle/libs.versions.toml\`:
            \`\`\`toml
            newpipe = "${latestVersion}"
            \`\`\`

            ### Why This Matters
            - YouTube frequently changes their API and streaming protocols
            - NewPipe Extractor updates fix playback issues caused by YouTube changes
            - Delays in updating can cause music playback to stop working

            ---
            *This issue was automatically created by the NewPipe update checker workflow.*`;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'newpipe-update'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Update NewPipe Extractor')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['newpipe-update', 'dependencies', 'priority-high']
              });
              console.log('Created new issue');
            }
